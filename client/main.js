import { Template } from 'meteor/templating';

import './main.html';

contractAddress = "0x97c195c38f607329832a1Bd2285Ac08929633Ce6";
//referred to as Interface in the Compiler
abi = [{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"furniture","outputs":[{"name":"item","type":"string"},{"name":"quantity","type":"uint256"},{"name":"unitPrice","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"transactionId","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"newItem","type":"string"},{"name":"newQuantity","type":"uint256"},{"name":"newUnitPrice","type":"uint256"}],"name":"send","outputs":[{"name":"tId","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"tId","type":"uint256"}],"name":"get","outputs":[{"name":"","type":"string"},{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"payable":false,"type":"function"}];
//referred to as byte code in the Compiler
data = "60606040526001600055341561001157fe5b5b6104e9806100216000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680631c87ef001461005c5780637e2f42e71461012057806384cb9cf4146101465780639507d39a146101c6575bfe5b341561006457fe5b61007a600480803590602001909190505061027b565b604051808060200184815260200183815260200182810382528581815460018160011615610100020316600290048152602001915080546001816001161561010002031660029004801561010f5780601f106100e45761010080835404028352916020019161010f565b820191906000526020600020905b8154815290600101906020018083116100f257829003601f168201915b505094505050505060405180910390f35b341561012857fe5b6101306102a4565b6040518082815260200191505060405180910390f35b341561014e57fe5b6101b0600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919080359060200190919080359060200190919050506102aa565b6040518082815260200191505060405180910390f35b34156101ce57fe5b6101e4600480803590602001909190505061030a565b604051808060200184815260200183815260200182810382528581815181526020019150805190602001908083836000831461023f575b80518252602083111561023f5760208201915060208101905060208303925061021b565b505050905090810190601f16801561026b5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b600160205280600052604060002060009150905080600001908060010154908060020154905083565b60005481565b6000600060006000815480929190600101919050559150600160008381526020019081526020016000209050848160000190805190602001906102ee929190610404565b508381600101819055508281600201819055505b509392505050565b610312610484565b600060006001600085815260200190815260200160002060000160016000868152602001908152602001600020600101546001600087815260200190815260200160002060020154828054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156103ef5780601f106103c4576101008083540402835291602001916103ef565b820191906000526020600020905b8154815290600101906020018083116103d257829003601f168201915b505050505092509250925092505b9193909250565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061044557805160ff1916838001178555610473565b82800160010185558215610473579182015b82811115610472578251825591602001919060010190610457565b5b5090506104809190610498565b5090565b602060405190810160405280600081525090565b6104ba91905b808211156104b657600081600090555060010161049e565b5090565b905600a165627a7a72305820ba4c05b026ab2616c0b79039140fffc10eee185f353dd850b198bcc72be310270029"


Template.hello.onCreated(function helloOnCreated() {
});

Template.hello.helpers({
  counter() {

    //initializing my contract
    myContract = web3.eth.contract(abi).at(contractAddress);

    //retrieving the account
    account = web3.eth.defaultAccount;
    var template = Template.instance();

    TemplateVar.set(template, "account", account);
  },
});

Template.hello.events({
  'click button#set'(event, instance) {

    var val1 = $('#item').val();
    var val2 = $('#quantity').val();
    var val3 = $('#unitP').val();;

    var template = Template.instance();

    myContract.send(val1,val2,val3, function (error, result) {
      if(!error){
        TemplateVar.set(template, "transaction", result);

        var filter = web3.eth.filter('latest');
        filter.watch( function(err, res){
          if (!err) {
            web3.eth.getTransaction(result, function (e, r) {
              if(r!=null){
                TemplateVar.set(template, "blockNo", r.blockNumber);
                filter.stopWatching();
              }
            })
          }
        })

      }
    });
  },
  'click button#get'(event, instance) {
    var template = Template.instance();
    var itemNo = $('#no').val();
    myContract.get(itemNo, function (error, result) {
      if(!error){
        TemplateVar.set(template, "item", result[0]);
        TemplateVar.set(template, "quantity", result[1]);
        TemplateVar.set(template, "price", result[2]);
      }
    });
  },
});
